new class{constructor(){this.isExtracting=!1,this.extractedMedia=[],this.mediaMap=new Set,this.DEBUG=!0,this.init()}log(...e){this.DEBUG&&console.log("[MediaExtractor]",...e)}init(){this.log("Initialized on",window.location.href),chrome.runtime.onMessage.addListener((e,t,a)=>(this.log("Received message:",e),"test"===e.action?a({success:!0}):"extractMedia"===e.action?(this.extractAllMedia().then(a).catch(e=>a({success:!1,message:e.message})),!0):(a({success:!1,message:"Unknown action"}),!0)))}async extractAllMedia(){if(this.isExtracting)throw new Error("Already extracting");const e=window.location.href;this.log("Starting extraction on URL:",e),this.isExtracting=!0,this.extractedMedia=[],this.mediaMap=new Set;try{const t=e.includes("behance.net"),a=e.includes("dribbble.com");if(!t&&!a)throw new Error("This extension only works on Behance and Dribbble pages");if(await new Promise(e=>setTimeout(e,3e3)),await this.scrollPage(),t?await this.extractBehanceMedia():a&&await this.extractDribbbleMedia(),this.extractedMedia&&0!==this.extractedMedia.length||await this.extractFromPageSource(t,a),!this.extractedMedia||0===this.extractedMedia.length)throw new Error("No media found on this page. Please try refreshing the page and trying again.");const r=this.generateFolderName(e,t,a);return this.log(`Extraction complete. Found ${this.extractedMedia?this.extractedMedia.length:0} media items.`),{success:!0,media:this.extractedMedia,thirdPartyVideos:[],folderName:r}}catch(e){throw this.log("Error during extraction:",e),e}finally{this.isExtracting=!1}}async scrollPage(){this.log("Scrolling page to load all content...");let e=0,t=0;for(let a=0;a<30;a++)if(window.scrollBy(0,.8*window.innerHeight),await new Promise(e=>setTimeout(e,1e3)),window.scrollY===e){if(t++,t>=3)break}else t=0,e=window.scrollY;window.scrollTo(0,0),await new Promise(e=>setTimeout(e,1e3)),this.log("Scrolling complete")}async extractBehanceMedia(){this.log("Extracting media from Behance page..."),await this.extractAllImages("behance.net");const e=document.querySelectorAll("video");let t=0;e&&e.length>0&&e.forEach(e=>{try{const a=e.src||e.querySelector("source")?.src;if(a&&a.includes("behance.net")){const e=this.enhanceVideoUrl(a);this.mediaMap.has(e)||(this.mediaMap.add(e),this.extractedMedia.push({type:"video",url:e,filename:this.getFileNameFromUrl(e)}),t++)}}catch(e){}}),this.log(`Added ${t} videos from Behance page`)}async extractDribbbleMedia(){this.log("Extracting media from Dribbble page..."),await this.extractAllImages("dribbble.com");const e=document.querySelectorAll("video, drb-video video");let t=0;e&&e.length>0&&e.forEach(e=>{try{const a=e.src||e.querySelector("source")?.src;if(a&&a.includes("dribbble.com")){const e=this.enhanceVideoUrl(a);this.mediaMap.has(e)||(this.mediaMap.add(e),this.extractedMedia.push({type:"video",url:e,filename:this.getFileNameFromUrl(e)}),t++)}}catch(e){}});const a=document.querySelectorAll(".dribbble-video");a&&a.length>0&&a.forEach(e=>{try{const a=e.dataset.video||e.dataset.videoSrc||e.dataset.videoUrl||e.querySelector("video")?.src;if(a){const e=this.enhanceVideoUrl(a);this.mediaMap.has(e)||(this.mediaMap.add(e),this.extractedMedia.push({type:"video",url:e,filename:this.getFileNameFromUrl(e)}),t++)}}catch(e){}}),this.log(`Added ${t} videos from Dribbble page`)}async extractAllImages(e){const t=document.querySelectorAll("img");this.log(`Found ${t?t.length:0} image elements`);let a=0;t&&t.length>0&&t.forEach(t=>{try{if(this.isSmallImage(t))return;let r=[];if("behance.net"===e){r=[t.dataset.src,t.dataset.highRes,t.dataset.original,t.dataset.originalSrc,t.dataset.fullsize,t.dataset.source,t.dataset.srcLarge,t.dataset.srcOriginal,t.dataset.srcFull,t.dataset.srcHd,t.dataset.srcMax,t.dataset.srcHigh,t.dataset.srcset?t.dataset.srcset.split(",").pop()?.trim().split(" ")[0]:null,this.getBestSrcFromSrcset(t.srcset),t.src].filter(Boolean);const e=t.closest("[data-hd-src]")||t.closest("[data-high-res]")||t.closest("[data-src]");e&&(r=[...[e.dataset.hdSrc,e.dataset.highRes,e.dataset.src].filter(Boolean),...r])}else if("dribbble.com"===e){r=[t.dataset.src,t.dataset.originalSrc,t.dataset.srcset?t.dataset.srcset.split(",").pop()?.trim().split(" ")[0]:null,t.dataset.original,t.dataset.srcLarge,t.dataset.srcOriginal,t.dataset.srcFull,t.dataset.srcHd,t.dataset.srcMax,t.dataset.srcHigh,this.getBestSrcFromSrcset(t.srcset),t.src].filter(Boolean);const e=t.closest("[data-2x-src]")||t.closest("[data-src]");e&&(r=[...[e.dataset["2xSrc"],e.dataset.src].filter(Boolean),...r])}else r=[t.dataset.src,t.dataset.highRes,t.dataset.original,t.dataset.originalSrc,t.dataset.fullsize,this.getBestSrcFromSrcset(t.srcset),t.src].filter(Boolean);for(const t of r){if(!t||t.includes("data:"))continue;if(!t.includes(e))continue;if(this.isUIElement(t))continue;const r=this.enhanceImageUrl(t);if(!this.mediaMap.has(r)){this.mediaMap.add(r),this.extractedMedia.push({type:"image",url:r,filename:this.getFileNameFromUrl(r)}),a++;break}}}catch(e){}});const r=document.querySelectorAll("*");let i=0;r.forEach(t=>{try{const a=window.getComputedStyle(t).backgroundImage;if(a&&"none"!==a&&a.includes("url(")){const t=a.match(/url\(['"]?(.*?)['"]?\)/);if(t&&t[1]){const a=t[1];if(a.includes(e)&&!this.isUIElement(a)){const e=this.enhanceImageUrl(a);this.mediaMap.has(e)||(this.mediaMap.add(e),this.extractedMedia.push({type:"image",url:e,filename:this.getFileNameFromUrl(e)}),i++)}}}}catch(e){}}),this.log(`Added ${a} images from img tags and ${i} from background images`)}async extractFromPageSource(e,t){this.log("Extracting media from page source...");try{const a=document.documentElement.outerHTML,r=e?"behance.net":"dribbble.com";let i=[];i=e?[new RegExp(`https:\\/\\/[^"']*\\.${r}\\/[^"']*\\/source\\/[^"']*`,"g"),new RegExp(`https:\\/\\/[^"']*\\.${r}\\/[^"']*\\/project\\/[^"']*`,"g"),new RegExp(`https:\\/\\/[^"']*\\.${r}\\/[^"']*\\/projects\\/[^"']*`,"g"),new RegExp(`https:\\/\\/[^"']*\\.${r}\\/[^"']*\\/galleries\\/[^"']*`,"g"),new RegExp(`https:\\/\\/[^"']*\\.${r}\\/[^"']*\\/covers\\/[^"']*`,"g"),new RegExp(`https:\\/\\/[^"']*\\.${r}\\/[^"']*\\/content\\/[^"']*`,"g"),new RegExp(`https:\\/\\/[^"']*\\.${r}\\/[^"']*\\/disp\\/[^"']*`,"g"),new RegExp(`https:\\/\\/[^"']*\\.${r}\\/[^"']*\\/hd\\/[^"']*`,"g"),new RegExp(`https:\\/\\/[^"']*\\.${r}\\/[^"']*\\/source\\/[^"']*`,"g"),new RegExp(`https:\\/\\/[^"']*\\.${r}\\/[^"']*\\/original\\/[^"']*`,"g"),new RegExp(`https:\\/\\/[^"']*\\.${r}\\/[^"']*\\/fs\\/[^"']*`,"g"),new RegExp(`https:\\/\\/[^"']*\\.${r}\\/[^"']*\\/project_modules\\/[^"']*`,"g"),new RegExp(`https:\\/\\/[^"']*\\.${r}\\/[^"']*\\/rendition\\/[^"']*`,"g"),new RegExp(`https:\\/\\/[^"']*\\.${r}\\/[^"']*\\.(?:jpg|jpeg|png|gif|webp)[^"']*`,"g"),new RegExp(`https:\\/\\/[^"']*\\.${r}\\/[^"']*\\/images\\/[^"']*`,"g"),new RegExp(`https:\\/\\/[^"']*\\.${r}\\/[^"']*\\/media\\/[^"']*`,"g"),new RegExp(`https:\\/\\/[^"']*\\.${r}\\/[^"']*\\.(?:mp4|webm|mov)[^"']*`,"g"),new RegExp(`https:\\/\\/[^"']*\\.${r}\\/[^"']*\\/video\\/[^"']*`,"g"),new RegExp(`https:\\/\\/[^"']*\\.${r}\\/[^"']*\\/mp4\\/[^"']*`,"g")]:t?[new RegExp(`https:\\/\\/[^"']*\\.${r}\\/[^"']*\\/original\\/[^"']*`,"g"),new RegExp(`https:\\/\\/[^"']*\\.${r}\\/[^"']*\\/attachments\\/[^"']*`,"g"),new RegExp(`https:\\/\\/[^"']*\\.${r}\\/[^"']*\\/shots\\/[^"']*`,"g"),new RegExp(`https:\\/\\/[^"']*\\.${r}\\/[^"']*@2x[^"']*`,"g"),new RegExp(`https:\\/\\/[^"']*\\.${r}\\/[^"']*_2x[^"']*`,"g"),new RegExp(`https:\\/\\/[^"']*\\.${r}\\/[^"']*-2x[^"']*`,"g"),new RegExp(`https:\\/\\/[^"']*\\.${r}\\/[^"']*\\.(?:jpg|jpeg|png|gif|webp)[^"']*`,"g"),new RegExp(`https:\\/\\/[^"']*\\.${r}\\/[^"']*\\/images\\/[^"']*`,"g"),new RegExp(`https:\\/\\/[^"']*\\.${r}\\/[^"']*\\/media\\/[^"']*`,"g"),new RegExp(`https:\\/\\/[^"']*\\.${r}\\/[^"']*\\.(?:mp4|webm|mov)[^"']*`,"g"),new RegExp(`https:\\/\\/[^"']*\\.${r}\\/[^"']*\\/video\\/[^"']*`,"g")]:[new RegExp(`https:\\/\\/[^"']*\\.${r}\\/[^"']*projects[^"']*`,"g"),new RegExp(`https:\\/\\/[^"']*\\.${r}\\/[^"']*galleries[^"']*`,"g"),new RegExp(`https:\\/\\/[^"']*\\.${r}\\/[^"']*covers[^"']*`,"g"),new RegExp(`https:\\/\\/[^"']*\\.${r}\\/[^"']*content[^"']*`,"g"),new RegExp(`https:\\/\\/[^"']*\\.${r}\\/[^"']*hd[^"']*`,"g"),new RegExp(`https:\\/\\/[^"']*\\.${r}\\/[^"']*source[^"']*`,"g"),new RegExp(`https:\\/\\/[^"']*\\.${r}\\/[^"']*original[^"']*`,"g"),new RegExp(`https:\\/\\/[^"']*\\.${r}\\/[^"']*\\.(?:jpg|jpeg|png|gif|webp)[^"']*`,"g"),new RegExp(`https:\\/\\/[^"']*\\.${r}\\/[^"']*images[^"']*`,"g"),new RegExp(`https:\\/\\/[^"']*\\.${r}\\/[^"']*media[^"']*`,"g"),new RegExp(`https:\\/\\/[^"']*\\.${r}\\/[^"']*\\.(?:mp4|webm|mov)[^"']*`,"g"),new RegExp(`https:\\/\\/[^"']*\\.${r}\\/[^"']*video[^"']*`,"g")];let s=new Set,l=0;i.forEach(e=>{try{const t=a.match(e);t&&Array.isArray(t)&&t.length>0&&t.forEach(e=>{const t=e.replace(/["'\\,\s]+$/,"");this.isUIElement(t)||s.add(t)})}catch(e){}}),s.forEach(e=>{try{const t=e.match(/\.(mp4|webm|mov)/)||e.includes("/video/"),a=t?this.enhanceVideoUrl(e):this.enhanceImageUrl(e);this.mediaMap.has(a)||(this.mediaMap.add(a),this.extractedMedia.push({type:t?"video":"image",url:a,filename:this.getFileNameFromUrl(a)}),l++)}catch(e){}}),this.log(`Added ${l} media items from page source`)}catch(e){this.log("Error extracting from page source:",e)}}generateFolderName(e,t,a){try{let r="";if(t)if(e.includes("/gallery/")){const t=e.split("/gallery/");if(t&&t.length>1){const e=t[1].split("/");e&&e.length>0&&(r=`behance-gallery-${e[0]}`)}}else{const t=new URL(e).pathname.split("/").filter(e=>e);r=t&&t.length>0?`behance-${t[0]}-portfolio`:`behance-${Date.now()}`}else if(a)if(e.includes("/shots/")){const t=e.split("/shots/");if(t&&t.length>1){const e=t[1].split("/");e&&e.length>0&&(r=`dribbble-shot-${e[0]}`)}}else{const t=new URL(e).pathname.split("/").filter(e=>e);r=t&&t.length>0?`dribbble-${t[0]}-portfolio`:`dribbble-${Date.now()}`}return r||(r=`download-${Date.now()}`),this.sanitizeFilename(r)}catch(e){return this.log("Error generating folder name:",e),`download-${Date.now()}`}}isSmallImage(e){try{if(!e)return!0;const t=parseInt(e.getAttribute("width"))||e.naturalWidth||0,a=parseInt(e.getAttribute("height"))||e.naturalHeight||0;return t>0&&t<150||a>0&&a<150}catch(e){return!1}}isUIElement(e){if(!e)return!0;try{const t=e.toLowerCase();return["avatar","icon","logo","badge","emoji","placeholder","thumbnail","sprite","button","banner","background","ui/","icons/","logos/","badges/","emojis/","profile-pic","profile_pic","profile_image","like","share","follow","subscribe","small","tiny","mini","/ui/","/icons/","/assets/","_icon.","_logo.","_badge.","_button.","-icon.","-logo.","-badge.","-button."].some(e=>t.includes(e))}catch(e){return!0}}getBestSrcFromSrcset(e){if(!e)return null;try{const t=e.split(",").map(e=>{const[t,a]=e.trim().split(/\s+/);return{url:t,width:a&&a.endsWith("w")?parseInt(a):0}}).sort((e,t)=>t.width-e.width);return t.length>0?t[0].url:null}catch(e){return null}}enhanceImageUrl(e){if(!e)return"";try{const t=e;let a=null;const r=e.match(/\/(\d+)x(\d+)\//);if(r&&(a={width:r[1],height:r[2]}),e.includes("behance.net")){const r=e.includes("?")?e.substring(e.indexOf("?")):"";if(e.includes("/projects/"))return a?e.replace(/_(small|medium|normal|tiny|large)\./,".").replace(/\/disp\//,"/source/").replace(/\/content\//,"/source/").replace(/\/resize\//,"/source/").replace(/\/230\//,`/${a.width}x${a.height}/`).replace(/\/400\//,`/${a.width}x${a.height}/`).replace(/\/600\//,`/${a.width}x${a.height}/`).replace(/\/800\//,`/${a.width}x${a.height}/`).replace(/\/1400\//,`/${a.width}x${a.height}/`).replace(/\/max_1200\//,`/${a.width}x${a.height}/`).replace(/\/fs\//,`/${a.width}x${a.height}/`)+r:e.replace(/_(small|medium|normal|tiny|large)\./,".").replace(/\/disp\//,"/source/").replace(/\/content\//,"/source/").replace(/\/resize\//,"/source/").replace(/\/230\//,"/source/").replace(/\/400\//,"/source/").replace(/\/600\//,"/source/").replace(/\/800\//,"/source/").replace(/\/1400\//,"/source/").replace(/\/max_1200\//,"/source/").replace(/\/fs\//,"/source/")+r;if(a)return e.replace(/_(small|medium|normal|tiny|large)\./,".").replace(/\/disp\//,"/source/").replace(/\/content\//,"/source/").replace(/\/resize\//,"/source/").replace(/\/mini\//,`/${a.width}x${a.height}/`).replace(/\/small\//,`/${a.width}x${a.height}/`).replace(/\/medium\//,`/${a.width}x${a.height}/`).replace(/\/large\//,`/${a.width}x${a.height}/`).replace(/\/preview\//,`/${a.width}x${a.height}/`).replace(/\d+x\d+bb/,`${a.width}x${a.height}`).replace(/_(1x|2x|3x)\./,".").replace(/\/[0-9]+x[0-9]+\//,`/${a.width}x${a.height}/`).replace(/size\/[0-9]+/,`size/${a.width}`).replace(/quality\/[0-9]+/,"quality/100").replace(/\/230\//,`/${a.width}x${a.height}/`).replace(/\/400\//,`/${a.width}x${a.height}/`).replace(/\/600\//,`/${a.width}x${a.height}/`).replace(/\/800\//,`/${a.width}x${a.height}/`).replace(/\/1400\//,`/${a.width}x${a.height}/`).replace(/\/max_1200\//,`/${a.width}x${a.height}/`).replace(/\/fs\//,`/${a.width}x${a.height}/`)+r;const i=e.replace(/_(small|medium|normal|tiny|large)\./,".").replace(/\/disp\//,"/source/").replace(/\/content\//,"/source/").replace(/\/resize\//,"/source/").replace(/\/mini\//,"/source/").replace(/\/small\//,"/source/").replace(/\/medium\//,"/source/").replace(/\/large\//,"/source/").replace(/\/preview\//,"/source/").replace(/\d+x\d+bb/,"original").replace(/_(1x|2x|3x)\./,".").replace(/\/[0-9]+x[0-9]+\//,"/source/").replace(/size\/[0-9]+/,"size/original").replace(/quality\/[0-9]+/,"quality/100").replace(/\/230\//,"/source/").replace(/\/400\//,"/source/").replace(/\/600\//,"/source/").replace(/\/800\//,"/source/").replace(/\/1400\//,"/source/").replace(/\/max_1200\//,"/source/").replace(/\/fs\//,"/source/")+r;return i.length<t.length/2?t:i}if(e.includes("dribbble.com")){const r=e.includes("?")?e.substring(e.indexOf("?")):"";if(a)return e.replace(/_(small|normal|tiny|large)\./,".").replace(/\/mini\//,`/${a.width}x${a.height}/`).replace(/\/small\//,`/${a.width}x${a.height}/`).replace(/\/teaser\//,`/${a.width}x${a.height}/`).replace(/\/medium\//,`/${a.width}x${a.height}/`).replace(/\/large\//,`/${a.width}x${a.height}/`).replace(/\/attachments\/thumbnails\//,"/attachments/original/").replace(/\/shots\/thumbnails\//,"/shots/original/").replace(/\/shots\/small\//,`/shots/${a.width}x${a.height}/`).replace(/\/shots\/normal\//,`/shots/${a.width}x${a.height}/`).replace(/\/shots\/large\//,`/shots/${a.width}x${a.height}/`)+r;const i=e.replace(/\?.*$/,"").replace(/_(small|normal|tiny|large)\./,".").replace(/\/mini\//,"/original/").replace(/\/small\//,"/original/").replace(/\/teaser\//,"/original/").replace(/\/medium\//,"/original/").replace(/\/large\//,"/original/").replace(/_1x\./,"_2x.").replace(/\.png$/,"@2x.png").replace(/\.jpg$/,"@2x.jpg").replace(/\.jpeg$/,"@2x.jpeg").replace(/\/attachments\/thumbnails\//,"/attachments/original/").replace(/\/shots\/thumbnails\//,"/shots/original/").replace(/\/shots\/small\//,"/shots/original/").replace(/\/shots\/normal\//,"/shots/original/").replace(/\/shots\/large\//,"/shots/original/");return i.length<t.length/2?t:i}if(a)return e.replace(/_(small|medium|normal|tiny|large)\./,".").replace(/\/mini\//,`/${a.width}x${a.height}/`).replace(/\/small\//,`/${a.width}x${a.height}/`).replace(/\/medium\//,`/${a.width}x${a.height}/`).replace(/\/large\//,`/${a.width}x${a.height}/`).replace(/\d+x\d+bb/,`${a.width}x${a.height}`).replace(/_(1x|2x|3x)\./,".").replace(/\/[0-9]+x[0-9]+\//,`/${a.width}x${a.height}/`).replace(/size\/[0-9]+/,`size/${a.width}`).replace(/quality\/[0-9]+/,"quality/100");const i=e.replace(/\?.*$/,"").replace(/_(small|medium|normal|tiny|large)\./,".").replace(/\/mini\//,"/original/").replace(/\/small\//,"/original/").replace(/\/medium\//,"/original/").replace(/\/large\//,"/original/").replace(/\d+x\d+bb/,"original").replace(/_(1x|2x|3x)\./,".").replace(/\/[0-9]+x[0-9]+\//,"/original/").replace(/size\/[0-9]+/,"size/original").replace(/quality\/[0-9]+/,"quality/100");return i.length<t.length/2?t:i}catch(t){return e}}enhanceVideoUrl(e){if(!e)return"";try{return e.includes("behance.net")?e.replace(/\?.*$/,"").replace(/_(low|medium|high)\./,".").replace(/_(240p|360p|480p|720p|1080p)\./,".1080p.").replace(/\/(sd|hd)\//,"/hd/").replace(/\/preview\//,"/source/").replace(/\/mp4\//,"/source/").replace(/\/compressed\//,"/source/").replace(/\/small\//,"/source/").replace(/\/medium\//,"/source/").replace(/\/large\//,"/source/").replace(/\/h264\//,"/source/").replace(/\/avc\//,"/source/").replace(/\/720p\//,"/1080p/").replace(/\/720P\//,"/1080P/").replace(/\/720\//,"/1080/"):e.includes("dribbble.com")?e.replace(/\?.*$/,"").replace(/_(low|medium|high)\./,".").replace(/_(240p|360p|480p|720p|1080p)\./,".1080p.").replace(/\/(sd|hd)\//,"/hd/").replace(/\/preview\//,"/video/").replace(/\/compressed\//,"/original/").replace(/\/small\//,"/large/").replace(/\/medium\//,"/large/").replace(/\/attachments\/thumbnails\//,"/attachments/original/").replace(/\/attachments\/small\//,"/attachments/original/").replace(/\/attachments\/normal\//,"/attachments/original/").replace(/\/attachments\/large\//,"/attachments/original/").replace(/\/720p\//,"/1080p/").replace(/\/720P\//,"/1080P/").replace(/\/720\//,"/1080/"):e.replace(/\?.*$/,"").replace(/_(low|medium|high)\./,".").replace(/_(240p|360p|480p|720p|1080p)\./,".1080p.").replace(/\/(sd|hd)\//,"/hd/").replace(/\/preview\//,"/video/").replace(/\/compressed\//,"/original/").replace(/\/small\//,"/large/").replace(/\/medium\//,"/large/")}catch(t){return e}}getFileNameFromUrl(e){try{if(!e)return`media-${Date.now()}.jpg`;const t=new URL(e).pathname.split("/").pop()||"media";return this.sanitizeFilename(t.includes(".")?t:`${t}.jpg`)}catch(e){return`media-${Date.now()}.jpg`}}sanitizeFilename(e){try{return e?e.replace(/[\/\\<>:"|?*&]/g,"_").substring(0,100):`file-${Date.now()}`}catch(e){return`file-${Date.now()}`}}},console.log("MediaExtractor content script loaded (simplified version with Behance & Dribbble support).");