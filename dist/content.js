new class{constructor(){this.isExtracting=!1,this.extractedMedia=[],this.thirdPartyVideos=[],this.projectModules=null,this.DEBUG=!1,this.init()}log(...e){this.DEBUG&&console.log("[MediaExtractor]",...e)}init(){this.log("Initialized on",window.location.href),chrome.runtime.onMessage.addListener(async(e,t,i)=>{if(this.log("Received message:",e),"test"===e.action)return i({success:!0});if("extractMedia"===e.action){const{extensionEnabled:e}=await chrome.storage.local.get({extensionEnabled:!0});return e?(this.extractAllMedia().then(i).catch(e=>i({success:!1,message:e.message})),!0):(i({success:!1,message:"Extension is OFF"}),!0)}return i({success:!1,message:"Unknown action"}),!0})}async extractAllMedia(){if(this.isExtracting)throw new Error("Already extracting");this.isExtracting=!0,this.extractedMedia=[],this.thirdPartyVideos=[];try{const e=window.location.href;let t;if(await this.scrollToLoadAll(),t=e.includes("behance.net/gallery/")?await this.extractBehanceGallery():e.includes("dribbble.com/shots/")?await this.extractDribbbleShot():e.includes("dribbble.com/")&&!e.includes("/shots/")?await this.extractDribbbleProfile():await this.extractGenericPage(),!this.extractedMedia.length){this.log("No media found with specific extractors, trying fallback extraction"),await this.scrollToLoadAll(),this.mediaMap=new Set,Array.from(document.querySelectorAll("img")).forEach(e=>{let t=[];e.srcset&&(t=e.srcset.split(",").map(e=>e.trim().split(" ")[0])),[e.src,e.dataset?.src,e.getAttribute("data-src"),e.getAttribute("data-lazy-src"),e.getAttribute("data-original"),e.getAttribute("data-hi-res"),e.getAttribute("data-retina")].forEach(e=>{e&&t.push(e)}),t=t.filter(e=>e&&!e.includes("data:")&&!e.match(/avatar|icon|logo|badge|emoji|placeholder/i));const i=this.pickBestQuality(t);i&&this.extractedMedia.push({type:"image",url:i,filename:this.getFileNameFromUrl(i)})});const e=document.documentElement.outerHTML;let t=[];[/https:\/\/[^"']*\.(?:jpg|jpeg|png|gif|webp)/g,/https:\/\/[^"']*images[^"']*\/[^"']+/g,/https:\/\/[^"']*media[^"']*\/[^"']+/g].forEach(i=>{const a=e.match(i);a&&(t=t.concat(a))}),[...new Set(t)].forEach(e=>{e.match(/avatar|icon|logo|badge|emoji|placeholder/i)||this.extractedMedia.push({type:"image",url:e,filename:this.getFileNameFromUrl(e)})}),this.extractedMedia=[...new Map(this.extractedMedia.map(e=>[e.url,e])).values()]}if(!this.extractedMedia.length)throw new Error("No media found on this page");return{success:!0,media:this.extractedMedia,thirdPartyVideos:this.thirdPartyVideos,folderName:t}}finally{this.isExtracting=!1}}sanitizeFilename(e){return e.replace(/[\/\\<>:"|?*&]/g,"_").substring(0,100)}getFileNameFromUrl(e){try{const t=new URL(e).pathname.split("/").pop()||"media";return this.sanitizeFilename(t.includes(".")?t:`${t}.jpg`)}catch{return`media-${Date.now()}.jpg`}}extractMediaFromList(e){e.forEach(e=>{const{url:t,type:i}=e;this.mediaMap.has(t)||(this.mediaMap.add(t),this.extractedMedia.push({type:i,url:t,filename:this.getFileNameFromUrl(t)}))})}pickBestQuality(e){if(!e||0===e.length)return null;const t=["original","full","max","4k","hd","large"],i=e.map(e=>{let i=0;const a=e.toLowerCase();return t.forEach((e,r)=>{a.includes(e)&&(i+=10*(t.length-r))}),i+=a.length,a.endsWith(".png")&&(i+=5),a.endsWith(".webp")&&(i+=3),{url:e,score:i}});return i.sort((e,t)=>t.score-e.score),i[0].url}async scrollToLoadAll(e=30,t=800){let i=document.body.scrollHeight;for(let a=0;a<e;a++){window.scrollBy(0,.7*window.innerHeight),await new Promise(e=>setTimeout(e,t));const e=document.body.scrollHeight;if(e===i)break;i=e}window.scrollTo(0,0)}gatherMedia(e){const t=Array.from(e.querySelectorAll("img")),i=Array.from(e.querySelectorAll("video source, video")),a=Array.from(e.querySelectorAll("iframe")),r=Array.from(e.querySelectorAll("*")),o=[];return t.forEach(e=>{let t=[];e.srcset&&(t=e.srcset.split(",").map(e=>e.trim().split(" ")[0])),[e.src,e.dataset?.src,e.getAttribute("data-src"),e.getAttribute("data-lazy-src"),e.getAttribute("data-original"),e.getAttribute("data-hi-res"),e.getAttribute("data-retina")].forEach(e=>{e&&t.push(e)}),t=t.filter(e=>e&&!e.includes("data:")&&!e.match(/avatar|icon|logo|badge|emoji|placeholder/i));const i=this.pickBestQuality(t);i&&o.push({type:"image",url:i})}),i.forEach(e=>{const t=e.src||e.closest("video")?.src;t&&o.push({type:"video",url:t})}),a.forEach(e=>{const t=e.src||e.dataset.src;t&&/(youtube\.com|vimeo\.com|player\.)/.test(t)&&this.thirdPartyVideos.push(t)}),r.forEach(e=>{const t=window.getComputedStyle(e).backgroundImage,i=t?.match(/url\(["']?(.+?)["']?\)/);i&&i[1]&&!i[1].includes("data:")&&o.push({type:"image",url:i[1]})}),r.forEach(e=>{const t=e.getAttribute("style");if(t&&t.includes("background-image")){const e=t.match(/background-image\s*:\s*url\(['"]?([^'"]+)['"]?\)/i);e&&e[1]&&!e[1].includes("data:")&&o.push({type:"image",url:e[1]})}}),r.forEach(e=>{const t=e.getAttribute("data-src"),i=e.getAttribute("data-high-res"),a=e.getAttribute("data-image");t&&!t.includes("data:")&&o.push({type:"image",url:t}),i&&!i.includes("data:")&&o.push({type:"image",url:i}),a&&!a.includes("data:")&&o.push({type:"image",url:a})}),o.filter(e=>e.url)}async extractBehanceGallery(){this.log("Behance gallery mode");const e=[document.getElementById("project-modules"),document.querySelector(".Project-projectModules"),document.querySelector(".project-module-container"),document.querySelector('[data-id="project-modules"]'),document.querySelector('[data-testid="project-modules"]'),document.querySelector('[class*="ProjectModule"]'),document.querySelector('[class*="projectModule"]'),document.querySelector("main"),document.querySelector(".gallery-content"),document.querySelector(".project-content"),document.querySelector(".content-wrapper")];this.projectModules=e.find(e=>null!==e),this.projectModules||(this.log("No specific container found, using document.body"),this.projectModules=document.body),await this.scrollToLoadAll(),this.mediaMap=new Set,this.extractMediaFromList(this.gatherMedia(this.projectModules));try{const e=Array.from(document.querySelectorAll("script")).map(e=>e.textContent).find(e=>e.includes("original_url")||e.includes("modules")||e.includes("projectModules"));if(e){const t=e.match(/window\.__INITIAL_STATE__\s*=\s*(\{[\s\S]*?\});/);let i=null;if(t)try{i=JSON.parse(t[1])}catch{}else{const t=e.indexOf("{");if(-1!==t)try{i=JSON.parse(e.slice(t,e.lastIndexOf("}")+1))}catch{}}if(i){const e=[],t=i=>{if(i&&"object"==typeof i)for(const a in i)"string"==typeof i[a]&&i[a].match(/^https?:\/\/.+\.(jpg|jpeg|png|webp|gif)$/i)?(i[a].toLowerCase().includes("original")||i[a].toLowerCase().includes("full"))&&e.push(i[a]):"object"==typeof i[a]&&t(i[a])};t(i),e.forEach(e=>{this.extractMediaFromList([{type:"image",url:e}])})}}}catch(e){this.log("Behance JSON parse error",e)}return this.log("Found",this.extractedMedia.length,"items"),0===this.extractedMedia.length&&(this.log("No media found in container, trying whole page"),this.projectModules=document.body,this.extractMediaFromList(this.gatherMedia(document.body))),this.sanitizeFilename((document.querySelector(".owner-name")?.innerText||"behance")+"-"+(window.location.pathname.split("/").pop()||"gallery"))}async extractDribbbleShot(){if(this.log("Dribbble shot mode"),this.projectModules=document.querySelector(".shot-content, .shot-container"),!this.projectModules)throw new Error("Not a Dribbble shot page");await this.scrollToLoadAll(),this.mediaMap=new Set,this.extractMediaFromList(this.gatherMedia(this.projectModules));try{const e=Array.from(document.querySelectorAll("script")).map(e=>e.textContent).find(e=>e.includes("original")||e.includes("full")||e.includes("images"));if(e){const t=e.match(/window\.__PRELOADED_STATE__\s*=\s*(\{[\s\S]*?\});/);let i=null;if(t)try{i=JSON.parse(t[1])}catch{}else{const t=e.indexOf("{");if(-1!==t)try{i=JSON.parse(e.slice(t,e.lastIndexOf("}")+1))}catch{}}if(i){const e=[],t=i=>{if(i&&"object"==typeof i)for(const a in i)"string"==typeof i[a]&&i[a].match(/^https?:\/\/.+\.(jpg|jpeg|png|webp|gif)$/i)?(i[a].toLowerCase().includes("original")||i[a].toLowerCase().includes("full"))&&e.push(i[a]):"object"==typeof i[a]&&t(i[a])};t(i),e.forEach(e=>{this.extractMediaFromList([{type:"image",url:e}])})}}}catch(e){this.log("Dribbble JSON parse error",e)}return this.log("Found",this.extractedMedia.length,"items"),this.sanitizeFilename((document.querySelector(".shot-user-name")?.innerText||"dribbble")+"-"+(window.location.pathname.split("/shots/")[1]||"shot"))}async extractDribbbleProfile(){this.log("Dribbble profile mode"),await this.scrollToLoadAll(),this.projectModules=document.body,this.mediaMap=new Set,this.extractMediaFromList(this.gatherMedia(this.projectModules)),this.log("Found",this.extractedMedia.length,"items");const e=window.location.pathname.split("/")[1]||"dribbble-user";return this.sanitizeFilename(`${e}-portfolio`)}async extractGenericPage(){this.log("Generic page mode"),await this.scrollToLoadAll(),this.projectModules=document.body,this.mediaMap=new Set,this.extractMediaFromList(this.gatherMedia(this.projectModules)),this.log("Found",this.extractedMedia.length,"items");const e=window.location.pathname.split("/").filter(e=>e).join("-")||"page";return this.sanitizeFilename(`page-${e}`)}},console.log("MediaExtractor content script loaded.");