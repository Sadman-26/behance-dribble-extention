new class{constructor(){this.isExtracting=!1,this.extractedMedia=[],this.thirdPartyVideos=[],this.projectModules=null,this.DEBUG=!1,this.init()}log(...t){this.DEBUG&&console.log("[MediaExtractor]",...t)}init(){this.log("Initialized on",window.location.href),chrome.runtime.onMessage.addListener((t,e,i)=>(this.log("Received message:",t),"test"===t.action?i({success:!0}):"extractMedia"===t.action?(this.extractAllMedia().then(i).catch(t=>i({success:!1,message:t.message})),!0):(i({success:!1,message:"Unknown action"}),!0)))}async extractAllMedia(){if(this.isExtracting)throw new Error("Already extracting");this.isExtracting=!0,this.extractedMedia=[],this.thirdPartyVideos=[];try{const t=window.location.href;let e;if(await this.scrollToLoadAll(),e=t.includes("behance.net/gallery/")?await this.extractBehanceGallery():t.includes("dribbble.com/shots/")?await this.extractDribbbleShot():t.includes("dribbble.com/")&&!t.includes("/shots/")?await this.extractDribbbleProfile():await this.extractGenericPage(),!this.extractedMedia.length){this.log("No media found with specific extractors, trying fallback extraction"),await this.scrollToLoadAll(),this.mediaMap=new Set,Array.from(document.querySelectorAll("img")).forEach(t=>{let e=[];t.srcset&&(e=t.srcset.split(",").map(t=>t.trim().split(" ")[0])),[t.src,t.dataset?.src,t.getAttribute("data-src"),t.getAttribute("data-lazy-src"),t.getAttribute("data-original"),t.getAttribute("data-hi-res"),t.getAttribute("data-retina")].forEach(t=>{t&&e.push(t)}),e=e.filter(t=>t&&!t.includes("data:")&&!t.match(/avatar|icon|logo|badge|emoji|placeholder/i));const i=this.pickBestQuality(e);i&&this.extractedMedia.push({type:"image",url:i,filename:this.getFileNameFromUrl(i)})});const t=document.documentElement.outerHTML;let e=[];[/https:\/\/[^"']*\.(?:jpg|jpeg|png|gif|webp)/g,/https:\/\/[^"']*images[^"']*\/[^"']+/g,/https:\/\/[^"']*media[^"']*\/[^"']+/g].forEach(i=>{const r=t.match(i);r&&(e=e.concat(r))}),[...new Set(e)].forEach(t=>{t.match(/avatar|icon|logo|badge|emoji|placeholder/i)||this.extractedMedia.push({type:"image",url:t,filename:this.getFileNameFromUrl(t)})}),this.extractedMedia=[...new Map(this.extractedMedia.map(t=>[t.url,t])).values()]}if(!this.extractedMedia.length)throw new Error("No media found on this page");return{success:!0,media:this.extractedMedia,thirdPartyVideos:this.thirdPartyVideos,folderName:e}}finally{this.isExtracting=!1}}sanitizeFilename(t){return t.replace(/[\/\\<>:"|?*&]/g,"_").substring(0,100)}getFileNameFromUrl(t){try{const e=new URL(t).pathname.split("/").pop()||"media";return this.sanitizeFilename(e.includes(".")?e:`${e}.jpg`)}catch{return`media-${Date.now()}.jpg`}}extractMediaFromList(t){t.forEach(t=>{const{url:e,type:i}=t;this.mediaMap.has(e)||(this.mediaMap.add(e),this.extractedMedia.push({type:i,url:e,filename:this.getFileNameFromUrl(e)}))})}bestSrc(t){return t.split(",").map(t=>t.trim().split(" ")).sort((t,e)=>(e[1]?.endsWith("w")?parseInt(e[1]):0)-(t[1]?.endsWith("w")?parseInt(t[1]):0)).map(t=>t[0])[0]}async scrollToLoadAll(t=30,e=800){let i=document.body.scrollHeight;for(let r=0;r<t;r++){window.scrollBy(0,.7*window.innerHeight),await new Promise(t=>setTimeout(t,e));const t=document.body.scrollHeight;if(t===i)break;i=t}window.scrollTo(0,0)}pickBestQuality(t){if(!t||0===t.length)return null;const e=["original","full","max","4k","hd","large"],i=t.map(t=>{let i=0;const r=t.toLowerCase();return e.forEach((t,a)=>{r.includes(t)&&(i+=10*(e.length-a))}),i+=r.length,r.endsWith(".png")&&(i+=5),r.endsWith(".webp")&&(i+=3),{url:t,score:i}});return i.sort((t,e)=>e.score-t.score),i[0].url}gatherMedia(t){const e=Array.from(t.querySelectorAll("img")),i=Array.from(t.querySelectorAll("video source, video")),r=Array.from(t.querySelectorAll("iframe")),a=Array.from(t.querySelectorAll("*")),o=[];return e.forEach(t=>{let e=[];t.srcset&&(e=t.srcset.split(",").map(t=>t.trim().split(" ")[0])),[t.src,t.dataset?.src,t.getAttribute("data-src"),t.getAttribute("data-lazy-src"),t.getAttribute("data-original"),t.getAttribute("data-hi-res"),t.getAttribute("data-retina")].forEach(t=>{t&&e.push(t)}),e=e.filter(t=>t&&!t.includes("data:")&&!t.match(/avatar|icon|logo|badge|emoji|placeholder/i));const i=this.pickBestQuality(e);i&&o.push({type:"image",url:i})}),i.forEach(t=>{const e=t.src||t.closest("video")?.src;e&&o.push({type:"video",url:e})}),r.forEach(t=>{const e=t.src||t.dataset.src;e&&/(youtube\.com|vimeo\.com|player\.)/.test(e)&&this.thirdPartyVideos.push(e)}),a.forEach(t=>{const e=window.getComputedStyle(t).backgroundImage,i=e?.match(/url\(["']?(.+?)["']?\)/);i&&i[1]&&!i[1].includes("data:")&&o.push({type:"image",url:i[1]})}),a.forEach(t=>{const e=t.getAttribute("style");if(e&&e.includes("background-image")){const t=e.match(/background-image\s*:\s*url\(['"]?([^'"]+)['"]?\)/i);t&&t[1]&&!t[1].includes("data:")&&o.push({type:"image",url:t[1]})}}),a.forEach(t=>{const e=t.getAttribute("data-src"),i=t.getAttribute("data-high-res"),r=t.getAttribute("data-image");e&&!e.includes("data:")&&o.push({type:"image",url:e}),i&&!i.includes("data:")&&o.push({type:"image",url:i}),r&&!r.includes("data:")&&o.push({type:"image",url:r})}),o.filter(t=>t.url)}async extractBehanceGallery(){this.log("Behance gallery mode");const t=[document.getElementById("project-modules"),document.querySelector(".Project-projectModules"),document.querySelector(".project-module-container"),document.querySelector('[data-id="project-modules"]'),document.querySelector('[data-testid="project-modules"]'),document.querySelector('[class*="ProjectModule"]'),document.querySelector('[class*="projectModule"]'),document.querySelector("main"),document.querySelector(".gallery-content"),document.querySelector(".project-content"),document.querySelector(".content-wrapper")];this.projectModules=t.find(t=>null!==t),this.projectModules||(this.log("No specific container found, using document.body"),this.projectModules=document.body),await this.scrollToLoadAll(),this.mediaMap=new Set,this.extractMediaFromList(this.gatherMedia(this.projectModules));try{const t=Array.from(document.querySelectorAll("script")).map(t=>t.textContent).find(t=>t.includes("original_url")||t.includes("modules")||t.includes("projectModules"));if(t){const e=t.match(/window\.__INITIAL_STATE__\s*=\s*(\{[\s\S]*?\});/);let i=null;if(e)try{i=JSON.parse(e[1])}catch{}else{const e=t.indexOf("{");if(-1!==e)try{i=JSON.parse(t.slice(e,t.lastIndexOf("}")+1))}catch{}}if(i){const t=[],e=i=>{if(i&&"object"==typeof i)for(const r in i)"string"==typeof i[r]&&i[r].match(/^https?:\/\/.+\.(jpg|jpeg|png|webp|gif)$/i)?(i[r].toLowerCase().includes("original")||i[r].toLowerCase().includes("full"))&&t.push(i[r]):"object"==typeof i[r]&&e(i[r])};e(i),t.forEach(t=>{this.extractMediaFromList([{type:"image",url:t}])})}}}catch(t){this.log("Behance JSON parse error",t)}return this.log("Found",this.extractedMedia.length,"items"),0===this.extractedMedia.length&&(this.log("No media found in container, trying whole page"),this.projectModules=document.body,this.extractMediaFromList(this.gatherMedia(document.body))),this.sanitizeFilename((document.querySelector(".owner-name")?.innerText||"behance")+"-"+(window.location.pathname.split("/").pop()||"gallery"))}async extractDribbbleShot(){if(this.log("Dribbble shot mode"),this.projectModules=document.querySelector(".shot-content, .shot-container"),!this.projectModules)throw new Error("Not a Dribbble shot page");await this.scrollToLoadAll(),this.mediaMap=new Set,this.extractMediaFromList(this.gatherMedia(this.projectModules));try{const t=Array.from(document.querySelectorAll("script")).map(t=>t.textContent).find(t=>t.includes("original")||t.includes("full")||t.includes("images"));if(t){const e=t.match(/window\.__PRELOADED_STATE__\s*=\s*(\{[\s\S]*?\});/);let i=null;if(e)try{i=JSON.parse(e[1])}catch{}else{const e=t.indexOf("{");if(-1!==e)try{i=JSON.parse(t.slice(e,t.lastIndexOf("}")+1))}catch{}}if(i){const t=[],e=i=>{if(i&&"object"==typeof i)for(const r in i)"string"==typeof i[r]&&i[r].match(/^https?:\/\/.+\.(jpg|jpeg|png|webp|gif)$/i)?(i[r].toLowerCase().includes("original")||i[r].toLowerCase().includes("full"))&&t.push(i[r]):"object"==typeof i[r]&&e(i[r])};e(i),t.forEach(t=>{this.extractMediaFromList([{type:"image",url:t}])})}}}catch(t){this.log("Dribbble JSON parse error",t)}return this.log("Found",this.extractedMedia.length,"items"),this.sanitizeFilename((document.querySelector(".shot-user-name")?.innerText||"dribbble")+"-"+(window.location.pathname.split("/shots/")[1]||"shot"))}async extractDribbbleProfile(){this.log("Dribbble profile mode"),await this.scrollToLoadAll(),this.projectModules=document.body,this.mediaMap=new Set,this.extractMediaFromList(this.gatherMedia(this.projectModules)),this.log("Found",this.extractedMedia.length,"items");const t=window.location.pathname.split("/")[1]||"dribbble-user";return this.sanitizeFilename(`${t}-portfolio`)}async extractGenericPage(){this.log("Generic page mode"),await this.scrollToLoadAll(),this.projectModules=document.body,this.mediaMap=new Set,this.extractMediaFromList(this.gatherMedia(this.projectModules)),this.log("Found",this.extractedMedia.length,"items");const t=window.location.pathname.split("/").filter(t=>t).join("-")||"page";return this.sanitizeFilename(`page-${t}`)}},console.log("MediaExtractor content script loaded.");